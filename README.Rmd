---
output: github_document
bibliography: vignettes/REFERENCES.bib
link-citations: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
options(digits = 4)
```

# ratesci <a href="https://petelaud.github.io/ratesci/"><img src="man/figures/logo.png" alt="ratesci website" align="right" height="139"/></a>

<!-- badges: start -->

[![R-CMD-check](https://github.com/petelaud/ratesci/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/petelaud/ratesci/actions/workflows/R-CMD-check.yaml) [![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0) [![CRAN_Version](https://www.r-pkg.org/badges/version/ratesci)](https://cran.r-project.org/package=ratesci) [![Total Downloads](https://cranlogs.r-pkg.org/badges/grand-total/ratesci)](https://cranlogs.r-pkg.org/badges/grand-total/ratesci) [![Monthly Downloads](https://cranlogs.r-pkg.org/badges/ratesci)](https://cranlogs.r-pkg.org/badges/ratesci)

<!-- badges: end -->

ratesci is an [R](https://www.r-project.org) package to compute confidence intervals and tests for:

-   a single binomial proportion, or Poisson rate ('p')
-   binomial risk difference or Poisson rate difference ('RD')
-   binomial relative risk or Poisson rate ratio ('RR')
-   binomial odds ratio ('OR')
-   stratified calculations for any of the above
-   paired binomial contrasts RD and RR
-   paired odds ratio using the conditional model
-   binomial proportion from clustered data

A number of different methods are offered, but in each case, the recommended default is based on asymptotic score methodology (from [@wilson1927], [@miettinen1985] and [@tango1998a]), but including skewness corrections following the principles of [@gart1988]. The resulting family of skewness-corrected asymptotic score (SCAS) methods [@laud2017], [and Laud2025, under review] ensures equal-tailed coverage (or central location), in other words for a nominal 95% confidence interval, the one-sided non-coverage probability is (on average) close to 2.5% on each side. Stratified calculations are also catered for (e.g. meta-analysis, including random effects). Most of the above list is covered by `scoreci()`, with the exception of clustered proportions (which uses `clusterpci()`) and paired contrasts (`pairbinci()`).

In each case, the asymptotic score methods provide a corresponding hypothesis test against any specified null parameter value, for a superiority test or non-inferiority test, with guaranteed coherence between the test and interval. The superiority test is a variant of (and in many cases identical to) a Chi-squared test or CMH test, and the non-inferiority test is analogous to a Farrington-Manning test, all with improved control of Type 1 error achieved by the bias and skewness corrections. For paired proportions, the superiority test is an 'N-1' adjusted variant of the McNemar test, which appears (by empirical observation) never to violate the nominal significance level. (Further details of the relationships between SCAS tests and conventional Chi-squared and CMH tests are given [here](https://petelaud.github.io/ratesci/articles/tests.html).)

Another family of methods offered by the package, with reasonable performance for large (single-stratum) sample sizes (but without a corresponding hypothesis test), uses the Method of Variance Estimates Recovery (MOVER), also known as Square-and-Add [@newcombe2012, chapter 7]. These methods combine intervals calculated separately for each proportion. The recommended default gives the MOVER-J method, using Jeffreys equal-tailed intervals instead of the Wilson method preferred by Newcombe. This improves on traditional approximate methods with respect to one-sided and two-sided coverage, particularly in the case of RR, but does not match the performance of the SCAS method. As the Jeffreys interval is based on a Bayesian conjugate prior, the MOVER approach allows the option to incorporate prior beliefs about the rates in each group - by default, the non-informative Jeffreys $Beta(0.5, 0.5)$ priors are used. MOVER intervals are available in `moverci()` for all contrasts of independent binomial and Poisson rates, and in `pairbinci()` for the paired binomial contrasts.

For those wishing to achieve strictly conservative coverage, continuity adjustments are provided as approximations to "exact" methods, with the option to adjust the strength of the adjustment (as the Yates correction is widely recognised to be an over-conservative adjustment). The performance of these adjustments has not been extensively evaluated, but they appear to be more successful for SCAS than for MOVER, in terms of achieving conservative coverage.

An online calculator based on this package is available [here](https://ssu.shef.ac.uk/ratesci/calc.php). Plots illustrating the coverage properties of selected methods can be found [here](https://github.com/petelaud/ratesci/tree/master/plots), and [here](https://github.com/petelaud/cpplot/tree/master/plots). <!--and [here](https://ssu.shef.ac.uk/diffbinconf/) with SCAS labelled as GNbc -->

## Installation

The current official (i.e. [CRAN](https://CRAN.R-project.org/package=ratesci)) release can be installed within R with:

``` r
install.packages("ratesci")
```

The latest development version of the package can be installed with:

``` r
# install.packages("pak")
pak::pak("petelaud/ratesci")
```

This builds the package from source based on the current version on [GitHub](https://github.com/petelaud/ratesci)

## Example

Below is a basic example which shows you how to request a confidence interval for the difference between proportions 5/56 - 0/29. The `$call` output element shows that the default settings give an interval for the risk difference (`contrast = "RD"`), for binomial proportions (`distrib = "bin"`), at a 95% confidence level. Variance bias correction (`bcf`) and skewness correction (`skew`) are applied, continuity adjustment (`cc`) is not. This is the skewness-corrected asymptotic score ("SCAS") confidence interval. (For Miettinen-Nurminen, use `skew = FALSE`, for Gart-Nam, use `bcf = FALSE`.)

```{r example}
library(ratesci)
scoreci(x1 = 5, n1 = 56, x2 = 0, n2 = 29)
```

An example of a paired analysis follows, using the data from Table II of [@fagerland2014]. Here the bias and skewness corrections are again applied by default. Omitting both would produce the Tango asymptotic score interval for `contrast = "RD"`, or the Tang method for `contrast = "RR"`.

```{r example2}
pairbinci(x = c(1, 1, 7, 12))
```

#### Overview

ratesci contains the following functions:

For comparisons of rates (contrasts RD, RR and OR):

-   `scoreci()`: for score-based confidence intervals including SCAS, Miettinen-Nurminen and Gart-Nam, with or without stratification.
-   `scasci()`: wrapper function to compute SCAS intervals.
-   `tdasci()`: wrapper function to compute TDAS stratified intervals incorporating random effects.
-   `moverci()`: for the MOVER methods, including Newcombe and MOVER-J.
-   `moverbci()`: wrapper function to compute MOVER-B intervals.
-   `pairbinci()`: for paired binomial data, including SCAS, asymptotic score and MOVER methods for RD and RR, and transformed binomial intervals for conditional OR.

For single binomial or Poisson rates:

-   `scaspci()`: non-iterative SCAS method for a single rate. For stratified calculations use `scoreci()` with `contrast = "p"`.
-   `jeffreysci()`: wrapper function to compute Jeffreys interval for a single rate (with option to incorporate prior information).
-   `rateci()`: wrapper function for selected methods for a single rate, including SCAS, Jeffreys, midp and Clopper-Pearson/Garwood.
-   `clusterpci()`: Saha's Wilson-based interval for a single proportion based on clustered data, with a skewness-corrected version.
